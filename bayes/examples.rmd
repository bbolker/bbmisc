---
title: Examples
bibliography: bayes.bib
author: "Ben Bolker"
---

Includes material from Ian Dworkin and Jonathan Dushoff, but they bear no responsibility for the contents.

![](pix/cc-attrib-nc.png)

```{r setup, include=FALSE}
library(knitr)
knitr::opts_chunk$set()
library(pander)
library(emdbook)
```

## Simplifed Bayes workflow

1. Decide on model specification; journal it, along with justifications
2. Decide on priors, including prior predictive simulations
4. Data exploration (graphical)
5. Fit model
6. MCMC diagnostics
7. Model diagnostics, including comparing posterior predictive sims to data
8. Interpret/predict/etc.

## Examples

```{r pkgs, message = FALSE}
library(lme4)
library(brms)
library(broom.mixed)
library(tidybayes)
library(ggplot2); theme_set(theme_bw())
```

We'll fit the model `Reaction ~ Days + (Days|Subject)` (a linear regression + random-slopes model)

\[
\newcommand{\XX}{\mathbf X}
\newcommand{\ZZ}{\mathbf Z}
\newcommand{\bbeta}{\boldsymbol \beta}
\newcommand{\bb}{\mathbf b}
\newcommand{\zero}{\boldsymbol 0}
\begin{split}
\textrm{Reaction} & \sim \textrm{Normal}(\XX \bbeta + \ZZ \bb, \sigma^2) \\
\bb & \sim \textrm{MVNorm}(\zero, \Sigma) \\
\Sigma & = \textrm{block-diag}, \left( 
\begin{array}{cc}
\sigma^2_i & \sigma_{is} \\
\sigma_{is} & \sigma^2_{s}
\end{array}
\right)
\end{split}
\]


```{r lmer_fit}
form1 <- Reaction ~ Days + (Days|Subject)
m_lmer <- lmer(form1, sleepstudy)
```

```{r get_prior}
get_prior(form1, sleepstudy)
```

```{r prior0}
b_prior <- c(set_prior("normal(200, 50)", "Intercept"),
             set_prior("normal(0, 10)", "b")
             )
```

```{r prior1, cache=TRUE}
options(brms.backend = "cmdstanr")
test_prior <- function(p) {
    b <- brm(form1, sleepstudy, prior = p,
             sample_prior = 'only',   ## for prior predictive sim
             chains = 1, iter = 500,  ## very short sample for convenience
             silent = 2               ## be vewy vewy quiet ...
             )
    p_df <- sleepstudy |> add_predicted_draws(b)
    ## 'spaghetti plot'
    gg0 <- ggplot(p_df,aes(Days, .prediction, group=interaction(Subject,.draw))) +
        geom_line(alpha = 0.1)
    print(gg0)
    return(b)
}
test_prior(b_prior)
```

Info on default priors (Student t with 3 df, mean 0, scale equal to rescaled MAD??)
https://discourse.mc-stan.org/t/default-student-t-priors-in-brms/17197/7

```{r prior2, cache = TRUE}
## attempt at caching version, but needs to be updated/hacked to work
## devtools::source_gist(id = "f1994c0f8325abbc5d300600744af39d", filename="cbrm.R")
b_prior2 <- c(set_prior("normal(200, 10)", "Intercept"),
              set_prior("normal(0, 5)", "b"),
              set_prior("student_t(3, 0, 0.1)", "sd")
             )
test_prior(b_prior2)
```

```{r prior3, cache = TRUE}
b_prior3 <- c(set_prior("normal(200, 5)", "Intercept"),
              set_prior("normal(0, 2)", "b"),
              set_prior("student_t(3, 0, 0.01)", "sd")
             )
test_prior(b_prior3)
```

```{r prior4, cache = TRUE}
b_prior4 <- c(set_prior("normal(200, 5)", "Intercept"),
              set_prior("normal(0, 2)", "b"),
              set_prior("normal(0, 1)", "sd"),
              set_prior("normal(0, 1)", "sigma")
             )
test_prior(b_prior4)
```

```{r prior5, cache = TRUE}
b_prior5 <- c(set_prior("normal(200, 5)", "Intercept"),
              set_prior("normal(0, 5)", "b"),
              set_prior("student_t(10, 0, 3)", "sd"),
              set_prior("student_t(10, 0, 3)", "sigma")
             )
test_prior(b_prior5)
```


## References

::: {#refs}
:::

---

Last updated: `r format(Sys.time(), "%d %B %Y %H:%M")`



---
title: Examples
bibliography: bayes.bib
author: "Ben Bolker"
---

Includes material from Ian Dworkin and Jonathan Dushoff, but they bear no responsibility for the contents.

![](pix/cc-attrib-nc.png)

```{r setup, include=FALSE}
library(knitr)
knitr::opts_chunk$set()
library(pander)
library(emdbook)
```

# Simplified Bayes workflow

1. Decide on model specification; journal it, along with justifications
2. Decide on priors, including prior predictive simulations
4. Data exploration (graphical)
5. Fit model
6. MCMC diagnostics
7. Model diagnostics, including comparing posterior predictive sims to data
8. Interpret/predict/etc.

# Examples

## 'sleepstudy' data

From `?lme4::sleepstudy`, "The average reaction time per day (in milliseconds) for subjects in a sleep deprivation study." A standard example for mixed models.

```{r pkgs, message = FALSE}
library(lme4)
library(brms)
options(mc.cores = min(4, parallel::detectCores()-1))
if (require("unix")) {
    rlimit_as(10e9)  ## approx 10 GB?
}
library(broom.mixed)
library(purrr)
library(dplyr)
library(tidybayes)
library(bayesplot)
library(ggplot2); theme_set(theme_bw())
```

We'll fit the model `Reaction ~ Days + (Days|Subject)` (a linear regression + random-slopes model)

\[
\newcommand{\XX}{\mathbf X}
\newcommand{\ZZ}{\mathbf Z}
\newcommand{\bbeta}{\boldsymbol \beta}
\newcommand{\bb}{\mathbf b}
\newcommand{\zero}{\boldsymbol 0}
\begin{split}
\textrm{Reaction} & \sim \textrm{Normal}(\XX \bbeta + \ZZ \bb, \sigma^2) \\
\bb & \sim \textrm{MVNorm}(\zero, \Sigma) \\
\Sigma & = \textrm{block-diag}, \left( 
\begin{array}{cc}
\sigma^2_i & \sigma_{is} \\
\sigma_{is} & \sigma^2_{s}
\end{array}
\right)
\end{split}
\]

```{r form1}
form1 <- Reaction ~ Days + (Days|Subject)
```

### prior predictive simulation

```{r get_prior}
get_prior(form1, sleepstudy)
```

```{r prior0}
b_prior <- c(set_prior("normal(200, 50)", "Intercept"),
             set_prior("normal(0, 10)", "b")
             )
```

```{r prior1, cache = TRUE}
options(brms.backend = "cmdstanr")
test_prior <- function(p) {
    ## https://discourse.mc-stan.org/t/suppress-all-output-from-brms-in-markdown-files/30117/3
    capture.output(
        b <- brm(form1, sleepstudy, prior = p,
                 seed = 101,              ## reproducibility
                 sample_prior = 'only',   ## for prior predictive sim
                 chains = 1, iter = 500,  ## very short sample for convenience
                 silent = 2, refresh = 0  ## be vewy vewy quiet ...
                 )
    )
    p_df <- sleepstudy |> add_predicted_draws(b)
    ## 'spaghetti plot' of prior preds
    gg0 <- ggplot(p_df,aes(Days, .prediction, group=interaction(Subject,.draw))) +
        geom_line(alpha = 0.1)
    print(gg0)
    invisible(b) ## return without printing
}
test_prior(b_prior)
```

Info on default priors (Student t with 3 df, mean 0, scale equal to rescaled MAD??)
https://discourse.mc-stan.org/t/default-student-t-priors-in-brms/17197/7

```{r prior2, cache = TRUE, dependson = "prior1"}
## attempt at caching version, but needs to be updated/hacked to work
## devtools::source_gist(id = "f1994c0f8325abbc5d300600744af39d", filename="cbrm.R")
b_prior2 <- c(set_prior("normal(200, 10)", "Intercept"),
              set_prior("normal(0, 5)", "b"),
              set_prior("student_t(3, 0, 0.1)", "sd")
             )
test_prior(b_prior2)
```

Make all scales even smaller?

```{r prior3, cache = TRUE, dependson = "prior1"}
b_prior3 <- c(set_prior("normal(200, 5)", "Intercept"),
              set_prior("normal(0, 2)", "b"),
              set_prior("student_t(3, 0, 0.01)", "sd")
             )
test_prior(b_prior3)
```

We forgot to constrain the prior for the residual standard deviation!

```{r prior4, cache = TRUE, dependson = "prior1"}
b_prior4 <- c(set_prior("normal(200, 5)", "Intercept"),
              set_prior("normal(0, 2)", "b"),
              set_prior("normal(0, 1)", "sd"),
              set_prior("normal(0, 1)", "sigma")
             )
test_prior(b_prior4)
```

Now relax a bit ...

```{r prior5, cache = TRUE, warning = FALSE, dependson = "prior1"}
b_prior5 <- c(set_prior("normal(200, 10)", "Intercept"),
              set_prior("normal(0, 8)", "b"),
              set_prior("student_t(10, 0, 3)", "sd"),
              set_prior("student_t(10, 0, 3)", "sigma")
             )
test_prior(b_prior5)
```

## fitting

TO DO: fit with default prior, chosen prior, compare with lmer ...
setting seeds?

```{r lmer_fit}
m_lmer <- lmer(form1, sleepstudy)
```

```{r brms_fit_reg, eval = FALSE}
b_reg <- brm(form1, sleepstudy, prior = b_prior5,
             seed = 101,               ## reproducibility
             ## handle divergence
        control = list(adapt_delta = 0.95)
        )
b_default <- brm(form1, sleepstudy,
        seed = 101,              ## reproducibility
        )
```

```{r load}
load("examples1.rda")
```

## diagnose

```{r traceplot}
mcmc_trace(b_reg, regex_pars= "b_|sd_")
```

```{r proc_models}
res_bayes <- (list(brms_default = b_default, brms_reg = b_reg)
    |> purrr::map_dfr(~ tidy(., conf.int = TRUE), .id = "model")
)
## need to do separately - different conf.method choices
res_lmer <- (m_lmer
    |> tidy(conf.int = TRUE, conf.method = "profile")
    |> mutate(model = "lmer", .before = 1)
)
res <- (bind_rows(res_lmer, res_bayes)
    |> select(-c(std.error, statistic, component, group))
    |> filter(term != "(Intercept)")
)
```

```{r plot_models}
ggplot(res, aes(estimate, term, colour = model)) +
    geom_pointrange(aes(xmin = conf.low, xmax = conf.high),
                    position = position_dodge(width = 0.5))

```

## To do

- what's wrong with `b_prior5`? Looks reasonable, don't understand why the slope would be 
- why errors when running brms examples via `make`?
- how to cache results to avoid recompilation? (Can we switch priors without recompiling?)
- how to avoid memory hit (is it just avoiding rstan backend?)

## References

::: {#refs}
:::


---

Last updated: `r format(Sys.time(), "%d %B %Y %H:%M")`


